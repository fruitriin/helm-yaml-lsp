# ============================================================================
# ConfigMap/Secret参照 - 環境変数とボリューム
# ============================================================================
#
# 【テスト目的】
# - configMapKeyRef.name からConfigMap定義へのジャンプ
# - configMapKeyRef.key からConfigMapのdataキーへのジャンプ
# - secretKeyRef 参照のジャンプ
# - ボリュームマウントのConfigMap参照ジャンプ
#
# 【動作確認方法】
# 1. F5でExtension Development Hostを起動
# 2. このファイルとconfigmap-data.yamlを開く
# 3. configMapKeyRef.name の "app-config" にカーソルを置いてF12
# 4. configMapKeyRef.key の "database-url" にカーソルを置いてF12
#
# 【期待動作】
# ✅ "app-config" → configmap-data.yaml の metadata.name にジャンプ
# ✅ "database-url" → configmap-data.yaml の data.database-url にジャンプ
# ============================================================================

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: configmap-test-
  namespace: argo
spec:
  entrypoint: main
  templates:
    - name: main
      container:
        image: alpine:latest
        env:
          # ConfigMapKeyRef参照
          - name: DATABASE_URL
            valueFrom:
              configMapKeyRef:
                name: app-config      # → ConfigMap定義へジャンプ
                key: database-url     # → data.database-url へジャンプ

          - name: API_KEY
            valueFrom:
              configMapKeyRef:
                name: app-config
                key: api-endpoint

          # SecretKeyRef参照
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: app-secrets     # → Secret定義へジャンプ
                key: db-password      # → data.db-password へジャンプ

        # envFrom参照
        envFrom:
          - configMapRef:
              name: app-config        # → ConfigMap定義へジャンプ
          - secretRef:
              name: app-secrets       # → Secret定義へジャンプ

        volumeMounts:
          - name: config
            mountPath: /etc/config
          - name: secrets
            mountPath: /etc/secrets
            readOnly: true

      volumes:
        - name: config
          configMap:
            name: app-config          # → ConfigMap定義へジャンプ
            items:
              - key: config.yaml      # → data.config.yaml へジャンプ
                path: app.yaml
        - name: secrets
          secret:
            secretName: app-secrets   # → Secret定義へジャンプ
            items:
              - key: db-password      # → data.db-password へジャンプ
                path: password.txt
