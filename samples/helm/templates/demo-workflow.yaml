# ========================================
# Helm YAML LSP - 全機能デモワークフロー (Helm版)
# ========================================
#
# このファイルは、Phase 5までに実装された全機能を
# 上から順に確認できる包括的なデモファイルです。
#
# 【実装済み機能】
# ✅ Phase 2-3: Argo Workflows基本機能
# ✅ Phase 4: Helm機能
#    - .Values参照（Definition/Hover/Completion/Diagnostics）
#    - include/template関数のサポート
#    - Helm組み込み関数（quote, indent, toYaml等70+関数）
#    - .Chart変数（.Chart.Name, .Chart.Version等）
#    - .Release/.Capabilities変数
# ✅ Phase 5: ConfigMap/Secret参照サポート
#
# 【動作確認方法】
# 1. VSCode: F5でデバッグ起動、またはNeovimで開く
# 2. 下記の各セクションで動作確認
#    - F12（gd）: 定義へジャンプ
#    - ホバー: 詳細情報表示
#    - 入力時: 補完候補表示
#
# 【Helm構文について】
# - Argo変数はエスケープ: {{`{{workflow.name}}`}}
# - Helm変数はそのまま: {{ .Values.app.name }}
#
# ========================================

{{- if .Values.workflow.enabled }}
---
# ========================================
# Section 1: ConfigMap定義（Helm + Phase 5）
# ========================================
# Helmテンプレート構文でConfigMapを生成します
#
# ✅ F12: .Values.xxx → values.yamlへジャンプ
# ✅ ホバー: 値の型、値、説明を表示
# ✅ 補完: .Values配下のキーを補完

apiVersion: v1
kind: ConfigMap
metadata:
  # ✅ F12: include関数 → _helpers.tplへジャンプ
  # ✅ ホバー: ヘルパー関数の定義を表示
  name: {{ include "argo-workflow-sample.configMapName" . }}
  namespace: {{ .Values.namespace }}
  labels:
    # ✅ ホバー: .Chart変数の説明表示
    # ✅ F12: Chart.yamlへジャンプ
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/version: {{ .Chart.Version | quote }}
    helm.sh/chart: {{ printf "%s-%s" .Chart.Name .Chart.Version }}
    {{- include "argo-workflow-sample.labels" . | nindent 4 }}
data:
  # ✅ F12: .Values.app.* → values.yamlへジャンプ
  app.name: {{ .Values.app.name | quote }}
  app.version: {{ .Values.app.version | quote }}

  # ✅ Helm組み込み関数のホバー情報
  # quote: 文字列をクオートで囲む
  environment: {{ .Values.app.environment | quote }}
  log.level: {{ .Values.app.logLevel | quote }}

  # ✅ toYaml: オブジェクトをYAML形式に変換
  # ✅ indent: インデントを追加（4スペース）
  config.yaml: |
{{ .Values.config | toYaml | indent 4 }}

  # ✅ .Release変数: Helmリリース情報
  # ✅ ホバー: 各変数の説明表示
  release.name: {{ .Release.Name }}
  release.namespace: {{ .Release.Namespace }}
  release.service: {{ .Release.Service }}

  # ✅ .Capabilities変数: Kubernetesクラスター情報
  # ✅ ホバー: 変数の説明表示
  kube.version: {{ .Capabilities.KubeVersion.Version }}
  kube.api-versions: {{ .Capabilities.APIVersions | join ", " | quote }}

---
# ========================================
# Section 2: Secret定義（Helm + Phase 5）
# ========================================

apiVersion: v1
kind: Secret
metadata:
  name: {{ include "argo-workflow-sample.secretName" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "argo-workflow-sample.labels" . | nindent 4 }}
type: Opaque
data:
  # ✅ b64enc: Base64エンコード関数
  # ✅ ホバー: 関数のシグネチャと使用例を表示
  username: {{ .Values.secrets.username | b64enc | quote }}
  api-key: {{ .Values.secrets.apiKey | b64enc | quote }}
stringData:
  # stringDataはBase64エンコード不要
  # ✅ default: デフォルト値を提供
  password: {{ .Values.secrets.password | default "secret123" }}

---
# ========================================
# Section 3: WorkflowTemplate定義（Phase 2 + 4）
# ========================================

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ include "argo-workflow-sample.workflowTemplateName" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "argo-workflow-sample.labels" . | nindent 4 }}
spec:
  templates:
  # ------------------------------------------
  # 3.1: パラメータを受け取るテンプレート
  # ------------------------------------------
  - name: process-data
    inputs:
      parameters:
      - name: input-data
        description: "処理対象のデータ"
      - name: batch-size
        # ✅ F12: .Values.workflowTemplate.* → values.yamlへジャンプ
        default: {{ .Values.workflowTemplate.templates.processData.defaultBatchSize | quote }}
        description: "バッチサイズ"
    outputs:
      parameters:
      - name: result-count
        valueFrom:
          path: /tmp/count.txt
        description: "処理件数"
    container:
      # ✅ printf: 文字列フォーマット関数
      # ✅ ホバー: 関数の説明表示
      image: {{ printf "%s:%s" .Values.workflow.image.repository .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        # ✅ Argoテンプレート変数はエスケープが必要
        # {{`{{...}}`}} でエスケープ
        - |
          echo "Processing: {{`{{inputs.parameters.input-data}}`}}"
          echo "Batch size: {{`{{inputs.parameters.batch-size}}`}}"
          # ✅ F12（Argo側）: inputs.parametersへジャンプ
          echo "42" > /tmp/count.txt

  # ------------------------------------------
  # 3.2: ConfigMapを参照するテンプレート（Phase 5）
  # ------------------------------------------
  - name: use-configmap
    container:
      image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        - |
          echo "App: $APP_NAME v$APP_VERSION"
          echo "Environment: $ENVIRONMENT"
          echo "Release: $RELEASE_NAME"
      env:
      # ✅ F12 (name): ConfigMap定義へジャンプ
      # ✅ F12 (key): dataキーへジャンプ
      # ✅ ホバー: ConfigMapの内容表示
      - name: APP_NAME
        valueFrom:
          configMapKeyRef:
            # ✅ Helm関数で生成された名前
            name: {{ include "argo-workflow-sample.configMapName" . }}
            key: app.name
      - name: APP_VERSION
        valueFrom:
          configMapKeyRef:
            name: {{ include "argo-workflow-sample.configMapName" . }}
            key: app.version
      - name: ENVIRONMENT
        valueFrom:
          configMapKeyRef:
            name: {{ include "argo-workflow-sample.configMapName" . }}
            key: environment
      - name: RELEASE_NAME
        valueFrom:
          configMapKeyRef:
            name: {{ include "argo-workflow-sample.configMapName" . }}
            key: release.name

  # ------------------------------------------
  # 3.3: Secretを参照するテンプレート（Phase 5）
  # ------------------------------------------
  - name: use-secrets
    container:
      image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        - |
          echo "Username: $USERNAME"
          echo "Connecting with API key..."
      env:
      # ✅ F12: Secret定義へジャンプ
      # ✅ ホバー: Secretの値は[hidden]で隠蔽
      - name: USERNAME
        valueFrom:
          secretKeyRef:
            name: {{ include "argo-workflow-sample.secretName" . }}
            key: username
      - name: API_KEY
        valueFrom:
          secretKeyRef:
            name: {{ include "argo-workflow-sample.secretName" . }}
            key: api-key

---
# ========================================
# Section 4: メインワークフロー（Phase 2-5統合）
# ========================================

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  # ✅ Helm関数の組み合わせ
  # trunc: 文字列を切り詰める
  # trimSuffix: 末尾の文字を削除
  name: {{ include "argo-workflow-sample.fullname" . | trunc 50 | trimSuffix "-" }}-demo
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "argo-workflow-sample.labels" . | nindent 4 }}
  annotations:
    # ✅ toJson: オブジェクトをJSON形式に変換
    workflows.argoproj.io/version: {{ .Chart.AppVersion | default "unknown" | quote }}
    # ✅ now: 現在のタイムスタンプ
    # ✅ date: タイムスタンプをフォーマット
    generated-at: {{ now | date "2006-01-02T15:04:05Z07:00" | quote }}
spec:
  # ------------------------------------------
  # 4.1: Workflow全体のパラメータ
  # ------------------------------------------
  arguments:
    parameters:
    - name: dataset-name
      # ✅ F12: .Values.workflow.dataset.* → values.yamlへジャンプ
      value: {{ .Values.workflow.dataset.name | quote }}
      description: "処理対象のデータセット名"
    - name: max-records
      # ✅ toString: 数値を文字列に変換
      value: {{ .Values.workflow.dataset.maxRecords | toString | quote }}
      description: "最大処理レコード数"

  entrypoint: main-flow

  # ------------------------------------------
  # 4.2: Volume定義（ConfigMap/Secretマウント）
  # ------------------------------------------
  volumes:
  # ✅ F12: configMap.name → ConfigMap定義へジャンプ
  - name: config-volume
    configMap:
      name: {{ include "argo-workflow-sample.configMapName" . }}
  # ✅ F12: secret.secretName → Secret定義へジャンプ
  - name: secrets-volume
    secret:
      secretName: {{ include "argo-workflow-sample.secretName" . }}

  templates:
  # ------------------------------------------
  # 4.3: メインフロー（Steps構造）
  # ------------------------------------------
  - name: main-flow
    steps:
    # Step 1: 初期化
    - - name: initialize
        template: init-step

    # Step 2: データ処理（WorkflowTemplateを参照）
    - - name: process
        # ✅ F12: templateRef.name → WorkflowTemplateへジャンプ
        # ✅ F12: templateRef.template → テンプレート定義へジャンプ
        # ✅ ホバー: テンプレートの説明表示
        templateRef:
          name: {{ include "argo-workflow-sample.workflowTemplateName" . }}
          template: process-data
        arguments:
          parameters:
          # ✅ Argo変数参照（エスケープ必要）
          - name: input-data
            value: "{{`{{workflow.parameters.dataset-name}}`}}"
          - name: batch-size
            value: {{ .Values.workflow.dataset.batchSize | quote }}

    # Step 3: 結果検証
    - - name: validate
        template: validate-step
        arguments:
          parameters:
          # ✅ F12（Argo）: steps.process.outputsへジャンプ
          - name: record-count
            value: "{{`{{steps.process.outputs.parameters.result-count}}`}}"

    # Step 4: ConfigMapとSecretのテスト
    - - name: test-configmap
        templateRef:
          name: {{ include "argo-workflow-sample.workflowTemplateName" . }}
          template: use-configmap

      - name: test-secrets
        templateRef:
          name: {{ include "argo-workflow-sample.workflowTemplateName" . }}
          template: use-secrets

    # Step 5: Helm関数のデモ
    - - name: demo-helm-functions
        template: helm-functions-demo

  # ------------------------------------------
  # 4.4: ローカルテンプレート定義
  # ------------------------------------------
  - name: init-step
    container:
      image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        - |
          # ✅ Argo workflow変数（エスケープ）
          # ✅ ホバー: workflow変数の説明表示
          echo "Workflow Name: {{`{{workflow.name}}`}}"
          echo "Workflow Namespace: {{`{{workflow.namespace}}`}}"
          echo "Workflow UID: {{`{{workflow.uid}}`}}"
          echo "Created at: {{`{{workflow.creationTimestamp}}`}}"
          echo "Dataset: {{`{{workflow.parameters.dataset-name}}`}}"
          echo "Max Records: {{`{{workflow.parameters.max-records}}`}}"

          # Helm変数の出力
          echo "Chart: {{ .Chart.Name }} v{{ .Chart.Version }}"
          echo "Release: {{ .Release.Name }}"
          echo "Namespace: {{ .Release.Namespace }}"
      volumeMounts:
      - name: config-volume
        mountPath: /etc/config
      - name: secrets-volume
        mountPath: /etc/secrets

  - name: validate-step
    inputs:
      parameters:
      - name: record-count
        description: "処理されたレコード数"
    container:
      image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        - |
          COUNT={{`{{inputs.parameters.record-count}}`}}
          MAX={{`{{workflow.parameters.max-records}}`}}

          echo "Processed: $COUNT records"
          echo "Maximum: $MAX records"

          if [ "$COUNT" -gt "$MAX" ]; then
            echo "ERROR: Too many records processed!"
            exit 1
          fi

          echo "Validation: OK"
    # ✅ envFrom: ConfigMap全体を環境変数として読み込み
    envFrom:
    - configMapRef:
        name: {{ include "argo-workflow-sample.configMapName" . }}

  # ------------------------------------------
  # 4.5: Helm組み込み関数のデモ
  # ------------------------------------------
  - name: helm-functions-demo
    container:
      image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
      command: [sh, -c]
      args:
        - |
          echo "=== Helm Built-in Functions Demo ==="

          # ✅ upper/lower: 大文字/小文字変換
          echo "Environment: {{ .Values.app.environment | upper }}"

          # ✅ repeat: 文字列を繰り返す
          echo "{{ "=" | repeat 40 }}"

          # ✅ list/join: リストを作成して結合
          {{- $features := list "Definition" "Hover" "Completion" "Diagnostics" }}
          echo "Features: {{ $features | join ", " }}"

          # ✅ dict: 辞書を作成
          {{- $info := dict "name" .Chart.Name "version" .Chart.Version }}
          echo "Chart Info: {{ $info | toJson }}"

          # ✅ add/sub/mul/div: 数学関数
          echo "Batch Size x 2: {{ mul .Values.workflow.dataset.batchSize 2 }}"

          # ✅ ternary: 三項演算子
          {{- $env := ternary "PROD" "DEV" (eq .Values.app.environment "production") }}
          echo "Environment Mode: {{ $env }}"

          echo "=== Demo Complete ==="

{{- end }}

# ========================================
# 動作確認チェックリスト
# ========================================
#
# [ ] Phase 4: Helm機能
#     [ ] .Values参照
#         - F12: .Values.xxx → values.yamlへジャンプ
#         - ホバー: 値、型、説明を表示
#         - 補完: .Values配下のキーを補完
#         - エラー検出: 存在しないキー → エラー表示
#
#     [ ] include/template関数
#         - F12: include "xxx" → _helpers.tplへジャンプ
#         - ホバー: 関数定義を表示
#         - 補完: 定義済みテンプレート名を補完
#
#     [ ] Helm組み込み関数（70+ functions）
#         - ホバー: quote, indent, toYaml, b64enc, upper等
#         - 各関数のシグネチャ、説明、使用例を表示
#
#     [ ] .Chart変数
#         - F12: .Chart.Name等 → Chart.yamlへジャンプ
#         - ホバー: 変数の説明表示
#         - 補完: .Chart配下のプロパティを補完
#
#     [ ] .Release/.Capabilities変数
#         - ホバー: 各変数の説明表示
#         - 補完: 変数名を補完
#
# [ ] Phase 5: ConfigMap/Secret機能
#     [ ] ConfigMap参照
#         - F12: configMapKeyRef.name → ConfigMap定義へジャンプ
#         - F12: configMapKeyRef.key → dataキーへジャンプ
#         - ホバー: ConfigMapの内容表示（マルチライン対応）
#         - 補完: ConfigMap名、キー名を補完
#
#     [ ] Secret参照
#         - F12: secretKeyRef.name → Secret定義へジャンプ
#         - F12: secretKeyRef.key → dataキーへジャンプ
#         - ホバー: Secretの値は[hidden]で隠蔽
#         - 補完: Secret名、キー名を補完
#
#     [ ] Volume参照
#         - F12: volumes.configMap.name → ConfigMapへジャンプ
#         - F12: volumes.secret.secretName → Secretへジャンプ
#
#     [ ] エラー検出
#         - 存在しないConfigMap/Secret → エラー表示
#         - 存在しないキー → エラー表示
#
# [ ] Phase 2-3: Argo Workflows機能
#     [ ] templateRef
#         - F12: templateRef.name → WorkflowTemplateへジャンプ
#         - F12: templateRef.template → テンプレート定義へジャンプ
#
#     [ ] パラメータ参照
#         - F12: workflow.parameters.xxx → argumentsへジャンプ
#         - F12: inputs.parameters.xxx → 定義へジャンプ
#         - F12: steps.xxx.outputs.parameters.yyy → outputsへジャンプ
#
#     [ ] workflow変数
#         - ホバー: workflow.name, workflow.namespace等
#         - 各変数の説明を表示
#
# ========================================
