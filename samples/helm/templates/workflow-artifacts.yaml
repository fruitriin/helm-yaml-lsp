{{- if .Values.workflow.enabled }}
{{/*
============================================================================
inputs/outputs.artifacts - アーティファクトの受け渡し（Helm版）
============================================================================

【テスト目的】
- inputs.artifactsの定義へのジャンプ機能
- outputs.artifactsの定義へのジャンプ機能
- Argoアーティファクト変数のエスケープ

【動作確認方法】
1. F5でExtension Development Hostを起動
2. このファイルを開く
3. inputs.artifacts.input-file の "input-file" にカーソルを置いてF12
4. outputs.artifacts.output-file の "output-file" にカーソルを置いてF12

【期待動作】
✅ inputs.artifacts.input-file → inputs.artifacts定義にジャンプ
✅ outputs.artifacts.output-file → outputs.artifacts定義にジャンプ
============================================================================
*/}}

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: {{ include "argo-workflow-sample.fullname" . }}-artifacts-
  namespace: {{ .Values.namespace }}
spec:
  entrypoint: main
  templates:
    - name: main
      steps:
        - - name: generate
            template: generate-artifact

        - - name: consume
            template: consume-artifact
            arguments:
              artifacts:
                - name: input-file
                  from: "{{`{{steps.generate.outputs.artifacts.output-file}}`}}"

    - name: generate-artifact
      outputs:
        artifacts:
          - name: output-file
            path: /tmp/output.txt
      script:
        image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
        command: [sh]
        source: |
          echo "Generated content" > /tmp/output.txt
          echo "Output artifact: {{`{{outputs.artifacts.output-file}}`}}"

    - name: consume-artifact
      inputs:
        artifacts:
          - name: input-file
            path: /tmp/input.txt
      container:
        image: {{ .Values.workflow.image.repository }}:{{ .Values.workflow.image.tag }}
        command: [sh, -c]
        args:
          - |
            echo "Reading artifact at: {{`{{inputs.artifacts.input-file}}`}}"
            cat /tmp/input.txt
{{- end }}
